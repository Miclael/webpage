<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>è¨˜äº‹æé†’ - é›²ç«¯åŒæ­¥ç‰ˆ (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        @media (prefers-color-scheme: dark) {
            body { background-color: #000; color: #fff; }
            .glass { background: rgba(28, 28, 30, 0.9); border-color: #2c2c2e; }
        }
        .overdue-glow { animation: pulse-red 2s infinite; border-color: rgba(239, 68, 68, 0.6) !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        #toast { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: translateY(-100px); opacity: 0; }
        #toast.show { transform: translateY(20px); opacity: 1; }
        .icon-size { width: 18px; height: 18px; }
        
        .day-btn, .date-btn { display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.1s; }
        .day-btn { width: 32px; height: 32px; border-radius: 8px; font-size: 12px; }
        .date-btn { height: 32px; border-radius: 6px; font-size: 11px; }
        .active { background-color: #007aff; color: white; }
        .inactive { background-color: #f2f2f7; color: #8e8e93; }
        @media (prefers-color-scheme: dark) { .inactive { background-color: #1c1c1e; } }
        
        /* Skeleton Animation */
        .skeleton { background: #e5e7eb; position: relative; overflow: hidden; }
        @media (prefers-color-scheme: dark) { .skeleton { background: #1c1c1e; } }
        .skeleton::after { position: absolute; top: 0; right: 0; bottom: 0; left: 0; transform: translateX(-100%); background-image: linear-gradient(90deg, rgba(255, 255, 255, 0) 0, rgba(255, 255, 255, 0.2) 20%, rgba(255, 255, 255, 0.5) 60%, rgba(255, 255, 255, 0)); animation: shimmer 2s infinite; content: ''; }
        @media (prefers-color-scheme: dark) { .skeleton::after { background-image: linear-gradient(90deg, rgba(255, 255, 255, 0) 0, rgba(255, 255, 255, 0.05) 20%, rgba(255, 255, 255, 0.1) 60%, rgba(255, 255, 255, 0)); } }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* Filter Tabs */
        .filter-tab { transition: all 0.2s; border-radius: 999px; font-size: 0.85rem; padding: 0.5rem 1rem; font-weight: 700; color: #8e8e93; }
        .filter-tab.active-tab { background-color: #007aff; color: white; box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3); }

        /* Completion Animation */
        .task-completing {
            animation: complete-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes complete-pop {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
            50% { transform: scale(0.95); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.5); }
            100% { transform: scale(0.9); opacity: 0; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<body class="bg-[#f2f2f7] dark:bg-black min-h-screen pb-32">

    <!-- Icons -->
    <svg style="display: none;">
        <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></symbol>
        <symbol id="icon-calendar-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7.5"></path><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><line x1="19" y1="16" x2="19" y2="22"></line><line x1="16" y1="19" x2="22" y2="19"></line></symbol>
    </svg>

    <!-- Toast -->
    <div id="toast" class="fixed top-0 left-0 right-0 flex justify-center z-[100] pointer-events-none">
        <div class="bg-blue-600 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-xs text-center min-w-[150px] flex items-center justify-center gap-2 backdrop-blur-md">
            <span>å·²æ›´æ–°</span>
        </div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 px-6 pt-8 pb-4 border-b border-gray-200 dark:border-gray-800 transition-all">
        <div class="max-w-lg mx-auto space-y-4">
            <!-- Top Row: Title & Date -->
            <div class="flex justify-between items-end">
                <h1 class="text-2xl font-black tracking-tight text-gray-900 dark:text-white">è¨˜äº‹æé†’</h1>
                <p id="current-date" class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1.5 text-right"></p>
            </div>
            
            <!-- Bottom Row: Filter Tabs (Full Width) -->
            <div class="grid grid-cols-2 gap-1 bg-gray-200 dark:bg-gray-800 rounded-xl p-1">
                <button onclick="setFilter('active')" class="filter-tab active-tab" id="tab-active">å¾…è¾¦</button>
                <button onclick="setFilter('completed')" class="filter-tab" id="tab-completed">å·²å®Œæˆ</button>
            </div>
            
            <!-- Progress Bar -->
            <div class="w-full h-1 bg-gray-200 dark:bg-gray-800 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
        </div>
    </header>

    <!-- Main List -->
    <main id="task-list" class="max-w-lg mx-auto px-4 pt-5 space-y-3 pb-40 min-h-[60vh]"></main>

    <!-- Floating Action Button -->
    <div class="fixed bottom-8 left-0 right-0 px-6 flex justify-center z-30 pointer-events-none">
        <button onclick="openModal()" class="pointer-events-auto w-full max-w-md h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl shadow-xl shadow-blue-500/30 flex items-center justify-center gap-2 active:scale-95 transition-all">
            <svg class="icon-size" style="width:24px;height:24px"><use href="#icon-plus"/></svg>
            <span class="text-lg font-bold">æ–°å¢é‡è¦æé†’</span>
        </button>
    </div>

    <!-- Edit/Add Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end justify-center z-50 transition-opacity duration-300">
        <div class="bg-white dark:bg-[#1c1c1e] w-full max-w-lg rounded-t-[2rem] p-6 pb-12 shadow-2xl overflow-y-auto max-h-[90vh] transform transition-transform duration-300 translate-y-full" id="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-xl font-black">æ–°ä»»å‹™</h2>
                <button onclick="closeModal()" class="text-gray-400 font-bold text-sm px-3 py-1 bg-gray-100 dark:bg-gray-800 rounded-full">å–æ¶ˆ</button>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 block mb-1.5 uppercase tracking-wider">ä»»å‹™æ¨™é¡Œ</label>
                    <input type="text" id="t-title" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-gray-800 border-none font-bold text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šç¹³äº¤é›»è²»...">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 block mb-1.5 uppercase tracking-wider">åŸ·è¡Œæ—¥æœŸ</label>
                    <input type="date" id="t-date" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-gray-800 border-none font-bold text-sm outline-none">
                </div>
                
                <div class="space-y-3">
                    <label class="text-[10px] font-bold text-gray-400 block mb-1.5 uppercase tracking-wider">é‡è¤‡é »ç‡</label>
                    <select id="t-freq-mode" onchange="toggleFreqInputs()" class="w-full p-4 rounded-xl bg-gray-50 dark:bg-gray-800 border-none font-bold text-sm outline-none appearance-none">
                        <option value="none">ä¸€æ¬¡æ€§ä»»å‹™</option>
                        <option value="recurring">é–“éš”å¾ªç’° (æ¯...)</option>
                        <option value="weekly_days">æ¯é€±å›ºå®š</option>
                        <option value="monthly_dates">æ¯æœˆå›ºå®š</option>
                    </select>
                    
                    <div id="ui-recurring" class="hidden flex gap-3 items-center mt-2 animate-fade-in">
                        <span class="text-sm font-bold text-gray-400">æ¯</span>
                        <input type="number" id="t-freq-val" value="1" min="1" class="w-16 p-3 rounded-xl bg-gray-100 dark:bg-gray-700 border-none font-bold text-center text-sm outline-none">
                        <select id="t-freq-unit" class="flex-1 p-3 rounded-xl bg-gray-100 dark:bg-gray-700 border-none font-bold text-sm outline-none">
                            <option value="days">å¤©</option>
                            <option value="weeks">é€±</option>
                            <option value="months">å€‹æœˆ</option>
                            <option value="years">å¹´</option>
                        </select>
                    </div>

                    <div id="ui-weekly" class="hidden flex justify-between mt-2 animate-fade-in">
                        <button onclick="toggleDay(0)" class="day-btn inactive" data-day="0">æ—¥</button>
                        <button onclick="toggleDay(1)" class="day-btn inactive" data-day="1">ä¸€</button>
                        <button onclick="toggleDay(2)" class="day-btn inactive" data-day="2">äºŒ</button>
                        <button onclick="toggleDay(3)" class="day-btn inactive" data-day="3">ä¸‰</button>
                        <button onclick="toggleDay(4)" class="day-btn inactive" data-day="4">å››</button>
                        <button onclick="toggleDay(5)" class="day-btn inactive" data-day="5">äº”</button>
                        <button onclick="toggleDay(6)" class="day-btn inactive" data-day="6">å…­</button>
                    </div>

                    <div id="ui-monthly" class="hidden mt-2 animate-fade-in">
                        <div class="grid grid-cols-7 gap-2" id="date-picker-grid"></div>
                    </div>
                </div>

                <button onclick="saveTask()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-black text-lg active:scale-95 shadow-lg transition-transform mt-4">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60]">
        <div class="bg-white dark:bg-[#1c1c1e] w-[85%] max-w-sm rounded-3xl p-6 shadow-2xl transform transition-all scale-100 border border-gray-100 dark:border-gray-800">
            <div class="text-center">
                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">ğŸ“…</div>
                <h3 id="confirm-title" class="text-xl font-black text-gray-900 dark:text-white mb-2">å®Œæˆä»»å‹™ï¼Ÿ</h3>
                <p id="confirm-msg" class="text-gray-500 dark:text-gray-400 text-sm mb-6 font-bold leading-relaxed"></p>
                
                <!-- Extra Options for One-time Tasks -->
                <div id="confirm-extra-options" class="hidden mb-6 bg-gray-50 dark:bg-gray-800 p-4 rounded-2xl text-left border border-gray-100 dark:border-gray-700">
                    <label class="text-xs font-black text-gray-400 block mb-2 uppercase tracking-wide">æˆ–æ˜¯ï¼Œé ç´„ä¸‹æ¬¡åŸ·è¡Œï¼š</label>
                    <input type="date" id="confirm-next-date" class="w-full p-3 rounded-xl bg-white dark:bg-gray-700 border-none font-bold text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all text-gray-700 dark:text-white">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeConfirm(false)" class="py-3.5 rounded-2xl bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 font-bold text-sm hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">å–æ¶ˆ</button>
                <button onclick="closeConfirm(true)" class="py-3.5 rounded-2xl bg-blue-600 text-white font-bold text-sm shadow-lg shadow-blue-500/30 hover:bg-blue-700 active:scale-95 transition-all">ç¢ºèªå®Œæˆ</button>
            </div>
        </div>
    </div>

    <script>
        // Config
        const API_URL = "https://script.google.com/macros/s/AKfycbyHZINBz_yjT1Q3tZujwPc0TxAJpe1eKU5i47upXMHxaLXmc0P9l8ZT7Z6OifCq_30x/exec";
        const LOCAL_STORAGE_KEY = "memo_tasks_cache";

        // State
        let tasks = [];
        let editingId = null;
        let selectedDays = [];
        let selectedDates = [];
        let currentFilter = 'active'; // 'active', 'completed'
        let lastUserActionTime = 0; // Timestamp of last local modification
        let pendingTaskId = null; // For confirmation dialog

        // Utils: Date Handling (Standardized to avoid timezone issues)
        const DateUtils = {
            todayStr: () => {
                const d = new Date();
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            },
            format: (dStr) => {
                if (!dStr) return "";
                // Handle ISO strings or YYYY-MM-DD
                const parts = dStr.split('T')[0].split('-');
                if (parts.length < 3) return dStr;
                return `${parts[0]}-${parts[1]}-${parts[2]}`;
            },
            addDays: (dateStr, days) => {
                const d = new Date(dateStr);
                d.setDate(d.getDate() + days);
                return DateUtils.format(d.toISOString());
            },
            addMonths: (dateStr, months) => {
                const d = new Date(dateStr);
                d.setMonth(d.getMonth() + months);
                return DateUtils.format(d.toISOString());
            },
            addYears: (dateStr, years) => {
                const d = new Date(dateStr);
                d.setFullYear(d.getFullYear() + years);
                return DateUtils.format(d.toISOString());
            },
            prettyPrint: (dateStr) => {
                // Returns "YYYY-MM-DD (Mon)"
                const d = new Date(dateStr);
                const day = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
                return `${dateStr} (${day})`;
            }
        };

        // Utils: Security
        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Utils: Toast
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            const content = t.querySelector('div');
            
            let bgClass = type === 'loading' ? 'bg-gray-700' : type === 'error' ? 'bg-red-500' : 'bg-blue-600';
            let icon = type === 'loading' ? 'ğŸ”„' : type === 'error' ? 'âŒ' : 'âœ…';
            
            content.className = `${bgClass} text-white px-6 py-3 rounded-full shadow-2xl font-bold text-xs text-center min-w-[150px] flex items-center justify-center gap-2 backdrop-blur-md`;
            content.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
            
            t.classList.add('show');
            if (type !== 'loading') {
                setTimeout(() => t.classList.remove('show'), 2000);
            }
        }

        // Core: Initialization
        window.onload = () => {
            initDatePickerGrid();
            
            // 1. Load from LocalStorage (Instant Render)
            const cached = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (cached) {
                try {
                    tasks = JSON.parse(cached);
                    if (!Array.isArray(tasks)) tasks = [];
                    updateUI();
                } catch(e) { console.error("Cache parse error", e); }
            } else {
                renderSkeleton();
            }

            // 2. Fetch from API (Background Sync)
            loadTasks();
            
            // Set Header Date
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
        };

        function renderSkeleton() {
            const list = document.getElementById('task-list');
            let html = '';
            for(let i=0; i<3; i++) {
                html += `
                <div class="bg-white dark:bg-[#1c1c1e] p-4 rounded-[1.25rem] shadow-sm flex items-center gap-4 h-20 skeleton"></div>`;
            }
            list.innerHTML = html;
        }

        async function loadTasks() {
            if(tasks.length === 0) showToast('åŒæ­¥ä¸­...', 'loading');
            try {
                const fetchTime = Date.now();
                const response = await fetch(API_URL);
                
                // If user modified data while we were fetching, discard this old data
                if (fetchTime < lastUserActionTime) {
                    console.log('Skipping old sync data due to new local changes.');
                    return;
                }

                const cloudTasks = await response.json();
                if(Array.isArray(cloudTasks)) {
                    // Double check again just before applying
                    if (fetchTime < lastUserActionTime) return;

                    // Normalize dates to local YYYY-MM-DD to fix timezone issues
                    tasks = cloudTasks.map(t => {
                        if (t.date && t.date.includes('T')) {
                            const d = new Date(t.date);
                            const year = d.getFullYear();
                            const month = String(d.getMonth() + 1).padStart(2, '0');
                            const day = String(d.getDate()).padStart(2, '0');
                            return { ...t, date: `${year}-${month}-${day}` };
                        }
                        return t;
                    });
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tasks));
                    updateUI();
                    document.getElementById('toast').classList.remove('show');
                }
            } catch (error) {
                console.error(error);
                if(tasks.length === 0) showToast('é›¢ç·šæ¨¡å¼', 'error');
            }
        }

        function setFilter(mode) {
            currentFilter = mode;
            document.querySelectorAll('.filter-tab').forEach(el => el.classList.remove('active-tab'));
            document.getElementById(`tab-${mode}`).classList.add('active-tab');
            updateUI();
        }

        function updateUI() {
            const list = document.getElementById('task-list');
            const todayStr = DateUtils.todayStr();
            
            // Filter
            let filteredTasks = tasks.filter(t => {
                if(currentFilter === 'active') return !t.completed;
                if(currentFilter === 'completed') return t.completed;
                return true;
            });

            // Sort: Overdue -> Today -> Future -> Completed
            filteredTasks.sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                return DateUtils.format(a.date).localeCompare(DateUtils.format(b.date));
            });

            if (filteredTasks.length === 0) {
                const emptyMsg = currentFilter === 'active' ? 'æ²’æœ‰å¾…è¾¦äº‹é … ğŸ‰' : 'ç›®å‰æ²’æœ‰ä»»å‹™';
                list.innerHTML = `<div class="text-center py-20 text-gray-400 font-bold text-sm flex flex-col items-center gap-2 opacity-50"><span class="text-4xl">ğŸ“­</span>${emptyMsg}</div>`;
            } else {
                list.innerHTML = filteredTasks.map(t => {
                    const cleanDate = DateUtils.format(t.date);
                    let displayDate = cleanDate;
                    if (t.completed && t.completedAt) {
                        const cd = new Date(t.completedAt);
                        const yr = cd.getFullYear();
                        const mo = String(cd.getMonth() + 1).padStart(2, '0');
                        const da = String(cd.getDate()).padStart(2, '0');
                        const hr = String(cd.getHours()).padStart(2, '0');
                        const mi = String(cd.getMinutes()).padStart(2, '0');
                        displayDate = `${yr}-${mo}-${da} ${hr}:${mi}`;
                    }
                    const isOverdue = cleanDate < todayStr && !t.completed;
                    const isToday = cleanDate === todayStr && !t.completed;
                    const freqLabel = getFreqLabel(t);
                    const countLabel = t.completedCount > 0 ? `å·²åŸ·è¡Œ ${t.completedCount} æ¬¡` : '';
                    
                    return `
                        <div id="task-card-${t.id}" class="relative bg-white dark:bg-[#1c1c1e] p-4 rounded-[1.25rem] shadow-sm flex items-center gap-4 border-2 transition-all ${isOverdue ? 'overdue-glow border-red-500/30' : 'border-transparent dark:border-gray-800'} ${t.completed ? '' : 'hover:scale-[1.01]'}">
                            <button onclick="toggleTask('${t.id}')" class="shrink-0 w-8 h-8 rounded-xl border-2 flex items-center justify-center transition-colors ${t.completed ? 'bg-green-500 border-green-500 text-white' : isOverdue ? 'border-red-500 text-red-500' : isToday ? 'border-blue-500 text-blue-500' : 'border-gray-400 dark:border-gray-500 text-transparent hover:border-gray-500 dark:hover:border-gray-400'}">
                                <svg class="w-5 h-5 ${t.completed ? 'block' : 'hidden'}"><use href="#icon-check"/></svg>
                            </button>
                            
                            <div class="flex-1 min-w-0 cursor-pointer" onclick="${t.completed ? `startReschedule('${t.id}')` : `startEdit('${t.id}')`}">
                                <h3 class="font-bold text-base truncate ${t.completed ? 'line-through text-gray-500 dark:text-gray-400' : 'text-gray-800 dark:text-gray-100'}">${escapeHtml(t.title)}</h3>
                                <div class="flex flex-col items-start gap-1 mt-1">
                                    <div class="flex items-center gap-1.5">
                                        <span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${isOverdue ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400' : isToday ? 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400' : 'bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400'}">
                                            ${displayDate}
                                        </span>
                                        ${countLabel ? `<span class="text-[10px] font-black text-orange-500 bg-orange-50 dark:bg-orange-900/20 px-1.5 py-0.5 rounded-full">ğŸ”¥ ${countLabel}</span>` : ''}
                                    </div>
                                    ${freqLabel ? `<span class="text-[10px] font-bold text-blue-500 uppercase tracking-wider flex items-center gap-1 pl-0.5">ğŸ”„ ${freqLabel}</span>` : ''}
                                </div>
                            </div>
                            
                            <div class="flex gap-1 shrink-0">
                                ${t.completed ? `
                                    <button onclick="startReschedule('${t.id}')" class="text-blue-500 p-2 rounded-full hover:bg-blue-50 dark:hover:bg-blue-900/20 active:scale-90 transition-transform"><svg class="icon-size"><use href="#icon-calendar-plus"/></svg></button>
                                ` : `
                                    <button onclick="startEdit('${t.id}')" class="text-orange-500 p-2 rounded-full hover:bg-orange-50 dark:hover:bg-orange-900/20 active:scale-90 transition-transform"><svg class="icon-size"><use href="#icon-edit"/></svg></button>
                                `}
                                <button onclick="deleteTask('${t.id}')" class="text-red-500 p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 active:scale-90 transition-transform"><svg class="icon-size"><use href="#icon-trash"/></svg></button>
                            </div>
                        </div>`;
                }).join('');
            }
            
            // Progress Bar (Active / Total for Today)
            const todayTasks = tasks.filter(t => DateUtils.format(t.date) === todayStr);
            const pct = todayTasks.length > 0 ? (todayTasks.filter(t => t.completed).length / todayTasks.length) * 100 : 0;
            document.getElementById('progress-bar').style.width = pct + '%';
        }

        // Core: CRUD Operations with Rollback
        async function saveTask() {
            lastUserActionTime = Date.now();
            const title = document.getElementById('t-title').value.trim();
            const date = document.getElementById('t-date').value;
            const freqMode = document.getElementById('t-freq-mode').value;
            
            if (!title || !date) return showToast('è«‹å¡«å¯«å®Œæ•´', 'error');
            
            // Backup State
            const previousTasks = JSON.parse(JSON.stringify(tasks));
            
            const newData = {
                id: editingId || Date.now().toString(),
                title,
                date,
                freqMode,
                freqVal: parseInt(document.getElementById('t-freq-val').value),
                freqUnit: document.getElementById('t-freq-unit').value,
                selectedDays,
                selectedDates,
                completed: false,
                completedCount: 0
            };

            if (editingId) {
                const old = tasks.find(x => x.id == editingId);
                newData.completed = old.completed; 
                newData.completedAt = old.completedAt;
                newData.completedCount = old.completedCount || 0;
                tasks = tasks.map(x => x.id == editingId ? newData : x);
            } else {
                tasks.push(newData);
            }

            // Optimistic Update
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tasks));
            updateUI();
            closeModal();
            showToast('å„²å­˜ä¸­...', 'loading');

            // API Sync
            try {
                await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'save', data: newData }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                showToast('å·²å„²å­˜');
            } catch (e) {
                // Rollback
                console.error(e);
                tasks = previousTasks;
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tasks));
                updateUI();
                showToast('å„²å­˜å¤±æ•—ï¼Œå·²é‚„åŸ', 'error');
            }
        }

        function toggleTask(id) {
            const t = tasks.find(x => x.id == id);
            if (!t) return;

            // If checking an active task, ask for confirmation
            pendingTaskId = id;
            let msg = '';
            
            // Reset modal state
            document.getElementById('confirm-next-date').value = ''; 
            const extraOpts = document.getElementById('confirm-extra-options');
            extraOpts.classList.remove('hidden'); // Always show date picker option
            
            if (t.completed) {
                // Case: Unchecking a completed task (Restore)
                msg = `å°‡æ­¤ä»»å‹™æ¢å¾©ç‚ºå¾…è¾¦ï¼Ÿ<br><span class="text-xs text-gray-400">åŸæ—¥æœŸï¼š${t.date}</span>`;
                document.getElementById('confirm-title').innerText = 'æ¢å¾©ä»»å‹™ï¼Ÿ';
                document.getElementById('confirm-extra-options').querySelector('label').innerText = 'æˆ–æ˜¯ï¼Œè¨­å®šæ–°çš„åŸ·è¡Œæ—¥æœŸï¼š';
            } else {
                // Case: Checking an active task (Complete)
                document.getElementById('confirm-title').innerText = 'å®Œæˆä»»å‹™ï¼Ÿ';
                document.getElementById('confirm-extra-options').querySelector('label').innerText = 'æˆ–æ˜¯ï¼Œé ç´„ä¸‹æ¬¡åŸ·è¡Œï¼š';
                
                if (t.freqMode !== 'none') {
                    extraOpts.classList.add('hidden'); // Recurring tasks have auto-calculated dates
                    
                    // Calculate next date for preview
                    let nextDate = t.date;
                    if (t.freqMode === 'recurring') {
                        const v = t.freqVal || 1;
                        if (t.freqUnit === 'days') nextDate = DateUtils.addDays(nextDate, v);
                        else if (t.freqUnit === 'weeks') nextDate = DateUtils.addDays(nextDate, v * 7);
                        else if (t.freqUnit === 'months') nextDate = DateUtils.addMonths(nextDate, v);
                        else if (t.freqUnit === 'years') nextDate = DateUtils.addYears(nextDate, v);
                    } else if (t.freqMode === 'weekly_days') {
                        let d = new Date(nextDate);
                        do { d.setDate(d.getDate() + 1); } 
                        while (!t.selectedDays.includes(d.getDay()));
                        nextDate = DateUtils.format(d.toISOString());
                    } else if (t.freqMode === 'monthly_dates') {
                        let d = new Date(nextDate);
                        do { d.setDate(d.getDate() + 1); } 
                        while (!t.selectedDates.includes(d.getDate()));
                        nextDate = DateUtils.format(d.toISOString());
                    }
                    msg = `é€™æ˜¯å¾ªç’°ä»»å‹™ ğŸ”„<br>ä¸‹æ¬¡åŸ·è¡Œæ—¥å°‡è®Šæ›´ç‚ºï¼š<br><span class="text-blue-500 text-lg">${nextDate}</span>`;
                } else {
                    msg = `é€™æ˜¯ä¸€æ¬¡æ€§ä»»å‹™<br>å®Œæˆå¾Œå°‡å°å­˜ã€‚`;
                }
            }

            document.getElementById('confirm-msg').innerHTML = msg;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirm(result) {
            const modal = document.getElementById('confirm-modal');
            const manualNextDate = document.getElementById('confirm-next-date').value;
            
            modal.classList.add('hidden');
            
            if (result && pendingTaskId) {
                // If it's a completion action (not restoring), play animation
                const t = tasks.find(x => x.id == pendingTaskId);
                if (t && !t.completed) {
                    const taskCard = document.getElementById(`task-card-${pendingTaskId}`);
                    if (taskCard) {
                        taskCard.classList.add('task-completing');
                        // Wait for animation to finish before updating state and UI
                        setTimeout(() => {
                            executeToggle(pendingTaskId, manualNextDate);
                            pendingTaskId = null;
                        }, 400);
                        return; // Exit early, executeToggle will handle the rest
                    }
                }
                
                // Normal immediate execution for restore or if card not found
                executeToggle(pendingTaskId, manualNextDate);
            }
            pendingTaskId = null;
        }

        async function executeToggle(id, manualNextDate = null) {
            lastUserActionTime = Date.now();
            const previousTasks = JSON.parse(JSON.stringify(tasks));
            let targetTask = null; // The original task (updated)
            let snapshotTask = null; // The history record
            let actionType = 'complete';

            // 1. Rebuild tasks array
            let newTasks = [];
            for (let t of tasks) {
                if (t.id == id) {
                    let updatedTask = { ...t };
                    
                    // A. Case: Restore completed task
                    if (t.completed) {
                        updatedTask.completed = false;
                        updatedTask.completedAt = null;
                        actionType = 'restore';
                        // If manual date provided during restore, update it
                        if (manualNextDate) {
                            updatedTask.date = manualNextDate;
                        }
                        targetTask = updatedTask;
                        newTasks.push(updatedTask);
                    } 
                    // B. Case: Complete active task (Recurring Logic OR Manual Next Date)
                    else if (t.freqMode !== 'none' || manualNextDate) {
                        actionType = 'reschedule';
                        let dStr = t.date;
                        
                        // Create Snapshot (History Record)
                        snapshotTask = {
                            ...t,
                            id: t.id + "_" + Date.now(), // Unique ID
                            completed: true,
                            completedAt: new Date().toISOString(),
                            freqMode: 'none', // Snapshot is static
                            // date is the date it was supposed to be done (current t.date)
                            completedCount: (t.completedCount || 0) + 1
                        };

                        // Update Original Task (Reschedule)
                        updatedTask.completedCount = (updatedTask.completedCount || 0) + 1;

                        if (manualNextDate) {
                            // Use manual date if provided (Overrules freq calculation)
                            dStr = manualNextDate;
                        } else {
                            // Calculate next date based on frequency
                            if (t.freqMode === 'recurring') {
                                const v = t.freqVal || 1;
                                if (t.freqUnit === 'days') dStr = DateUtils.addDays(dStr, v);
                                else if (t.freqUnit === 'weeks') dStr = DateUtils.addDays(dStr, v * 7);
                                else if (t.freqUnit === 'months') dStr = DateUtils.addMonths(dStr, v);
                                else if (t.freqUnit === 'years') dStr = DateUtils.addYears(dStr, v);
                            } else if (t.freqMode === 'weekly_days') {
                                // Find next day in selectedDays
                                let d = new Date(dStr);
                                do { d.setDate(d.getDate() + 1); } 
                                while (!t.selectedDays.includes(d.getDay()));
                                dStr = DateUtils.format(d.toISOString());
                            } else if (t.freqMode === 'monthly_dates') {
                                // Find next date in selectedDates
                                let d = new Date(dStr);
                                do { d.setDate(d.getDate() + 1); } 
                                while (!t.selectedDates.includes(d.getDate()));
                                dStr = DateUtils.format(d.toISOString());
                            }
                        }
                        
                        updatedTask.date = dStr;
                        
                        targetTask = updatedTask;
                        newTasks.push(updatedTask);
                        newTasks.push(snapshotTask); // Add history to list

                    } else {
                        // C. Case: Complete One-time Task (Normal Toggle)
                        updatedTask.completed = true;
                        updatedTask.completedAt = new Date().toISOString();
                        if (updatedTask.completed) {
                            updatedTask.completedCount = (updatedTask.completedCount || 0) + 1;
                        }
                        targetTask = updatedTask;
                        newTasks.push(updatedTask);
                    }
                } else {
                    newTasks.push(t);
                }
            }
            
            tasks = newTasks;

            // Optimistic Update
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tasks));
            updateUI();
            
            // Toast & API Sync
            if(actionType === 'reschedule') {
                showToast(`å·²å­˜æª”ä¸¦å»¶æœŸè‡³ï¼š${targetTask.date}`);
                
                // Sync BOTH: Original (Update) + Snapshot (Create)
                try {
                    // 1. Save Snapshot
                    fetch(API_URL, { 
                        method: 'POST', 
                        body: JSON.stringify({ action: 'save', data: snapshotTask }),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    }); 
                    
                    // 2. Save Updated Original
                    await fetch(API_URL, { 
                        method: 'POST', 
                        body: JSON.stringify({ action: 'save', data: targetTask }),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });
                } catch (e) {
                     console.error(e);
                     showToast('åŒæ­¥å¤±æ•— (éƒ¨åˆ†è³‡æ–™å¯èƒ½æœªå„²å­˜)', 'error');
                }

            } else {
                showToast(targetTask.completed ? 'ä»»å‹™å®Œæˆï¼' : 'å·²æ¢å¾©ç‚ºå¾…è¾¦', 'loading');
                try {
                    await fetch(API_URL, { 
                        method: 'POST', 
                        body: JSON.stringify({ action: 'save', data: targetTask }),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });
                    showToast('å·²åŒæ­¥');
                } catch (e) {
                    tasks = previousTasks;
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tasks));
                    updateUI();
                    showToast('åŒæ­¥å¤±æ•—ï¼Œå·²é‚„åŸ', 'error');
                }
            }
        }

        async function deleteTask(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ')) return;
            
            lastUserActionTime = Date.now();
            const previousTasks = JSON.parse(JSON.stringify(tasks));
            tasks = tasks.filter(t => t.id != id);
            
            // Optimistic Update
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tasks));
            updateUI();
            showToast('åˆªé™¤ä¸­...', 'loading');

            try {
                await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'delete', id: id }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                showToast('å·²åˆªé™¤');
            } catch (e) {
                // Rollback
                tasks = previousTasks;
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tasks));
                updateUI();
                showToast('åˆªé™¤å¤±æ•—ï¼Œå·²é‚„åŸ', 'error');
            }
        }

        // Helper: UI Logic for Modal
        function initDatePickerGrid() {
            const grid = document.getElementById('date-picker-grid');
            grid.innerHTML = '';
            for (let i = 1; i <= 31; i++) {
                const b = document.createElement('button');
                b.className = 'date-btn inactive';
                b.innerText = i;
                b.onclick = () => {
                    if (selectedDates.includes(i)) selectedDates = selectedDates.filter(x => x !== i);
                    else selectedDates.push(i);
                    renderPickers();
                };
                b.dataset.date = i;
                grid.appendChild(b);
            }
        }

        function toggleDay(d) {
            if (selectedDays.includes(d)) selectedDays = selectedDays.filter(x => x !== d);
            else selectedDays.push(d);
            renderPickers();
        }

        function renderPickers() {
            document.querySelectorAll('.day-btn').forEach(btn => btn.className = 'day-btn ' + (selectedDays.includes(parseInt(btn.dataset.day)) ? 'active' : 'inactive'));
            document.querySelectorAll('.date-btn').forEach(btn => btn.className = 'date-btn ' + (selectedDates.includes(parseInt(btn.dataset.date)) ? 'active' : 'inactive'));
        }

        function toggleFreqInputs() {
            const m = document.getElementById('t-freq-mode').value;
            document.getElementById('ui-recurring').classList.toggle('hidden', m !== 'recurring');
            document.getElementById('ui-weekly').classList.toggle('hidden', m !== 'weekly_days');
            document.getElementById('ui-monthly').classList.toggle('hidden', m !== 'monthly_dates');
        }

        function getFreqLabel(t) {
            if (!t.freqMode || t.freqMode === 'none') return '';
            if (t.freqMode === 'recurring') {
                const unitMap = { days: 'å¤©', weeks: 'é€±', months: 'å€‹æœˆ', years: 'å¹´' };
                return `æ¯ ${t.freqVal} ${unitMap[t.freqUnit] || ''}`;
            }
            if (t.freqMode === 'weekly_days' && t.selectedDays) return `æ¯é€± ${t.selectedDays.sort().map(d => ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d]).join('')}`;
            if (t.freqMode === 'monthly_dates' && t.selectedDates) return `æ¯æœˆ ${t.selectedDates.sort((a,b)=>a-b).join(',')} è™Ÿ`;
            return '';
        }

        function openModal() {
            editingId = null; selectedDays = []; selectedDates = [];
            document.getElementById('modal-title').innerText = 'æ–°ä»»å‹™';
            document.getElementById('t-title').value = '';
            document.getElementById('t-date').value = DateUtils.todayStr();
            document.getElementById('t-freq-mode').value = 'none';
            toggleFreqInputs(); renderPickers();
            showModalUI();
        }

        function startEdit(id) {
            const t = tasks.find(x => x.id == id);
            if (!t) return;
            editingId = id;
            document.getElementById('modal-title').innerText = 'ä¿®æ”¹ä»»å‹™';
            document.getElementById('t-title').value = t.title;
            document.getElementById('t-date').value = DateUtils.format(t.date);
            document.getElementById('t-freq-mode').value = t.freqMode || 'none';
            document.getElementById('t-freq-val').value = t.freqVal || 1;
            document.getElementById('t-freq-unit').value = t.freqUnit || 'days';
            selectedDays = t.selectedDays || [];
            selectedDates = t.selectedDates || [];
            toggleFreqInputs(); renderPickers();
            showModalUI();
        }

        function startReschedule(id) {
            const t = tasks.find(x => x.id == id);
            if (!t) return;
            editingId = id;
            document.getElementById('modal-title').innerText = 'è¨­å®šä¸‹æ¬¡æ—¥æœŸ';
            document.getElementById('t-title').value = t.title;
            document.getElementById('t-date').value = DateUtils.todayStr();
            document.getElementById('t-freq-mode').value = 'none'; 
            toggleFreqInputs(); renderPickers();
            showModalUI();
        }

        // Modal Transitions
        function showModalUI() {
            const m = document.getElementById('modal');
            const c = document.getElementById('modal-content');
            m.classList.remove('hidden');
            setTimeout(() => { c.classList.remove('translate-y-full'); }, 10);
            if (!history.state || !history.state.modal) history.pushState({ modal: true }, "");
        }

        function closeModal() {
            if (history.state && history.state.modal) history.back();
            else {
                const m = document.getElementById('modal');
                const c = document.getElementById('modal-content');
                c.classList.add('translate-y-full');
                setTimeout(() => m.classList.add('hidden'), 300);
            }
        }

        window.onpopstate = function(event) {
            const m = document.getElementById('modal');
            const c = document.getElementById('modal-content');
            c.classList.add('translate-y-full');
            setTimeout(() => m.classList.add('hidden'), 300);
        };
    </script>
</body>
</html>